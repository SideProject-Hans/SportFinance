@page "/bank/tcb"
@using FinanceCenter.Components.Dialogs

<PageTitle>合作金庫帳戶明細</PageTitle>

<div class="bank-page">
	@* 頁面標題 *@
	<header class="bank-header">
		<div class="bank-header__icon bank-header__icon--tcb">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
				<path d="M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"/>
			</svg>
		</div>
		<div class="bank-header__content">
			<h1 class="bank-header__title">合作金庫帳戶明細</h1>
			<p class="bank-header__subtitle">Taiwan Cooperative Bank Account Details</p>
		</div>
	</header>

	@* 統計卡片區 *@
	<section class="bank-stats">
		@* 年份選擇卡片 *@
		<div class="stat-card stat-card--info">
			<div class="stat-card__header">
				<span class="stat-card__label">選擇年份</span>
				<svg class="stat-card__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
					<path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM5 8V6h14v2H5z"/>
				</svg>
			</div>
			<div class="year-select">
				<select class="year-select__input" @onchange="OnYearChangedAsync">
					@for (int year = 2019; year <= 2030; year++)
					{
						<option value="@year" selected="@(year == SelectedYear)">@year 年</option>
					}
				</select>
				<svg class="year-select__arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
					<path d="M7 10l5 5 5-5H7z"/>
				</svg>
			</div>
		</div>

		@* 年初餘額卡片 *@
		<div class="stat-card stat-card--trust">
			<div class="stat-card__header">
				<span class="stat-card__label">年初餘額</span>
				<svg class="stat-card__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
					<path d="M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"/>
				</svg>
			</div>
			<div class="stat-card__value @(OpeningBalance < 0 ? "stat-card__value--loss" : "")">
				@OpeningBalance.ToString("N0")
			</div>
			<span class="stat-card__subtitle">上年度結餘</span>
		</div>

		@* 本年度淨額卡片 *@
		<div class="stat-card @(CurrentYearNetAmount >= 0 ? "stat-card--profit" : "stat-card--loss")">
			<div class="stat-card__header">
				<span class="stat-card__label">本年度淨額</span>
				@if (CurrentYearNetAmount >= 0)
				{
					<svg class="stat-card__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/>
					</svg>
				}
				else
				{
					<svg class="stat-card__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6h-6z"/>
					</svg>
				}
			</div>
			<div class="stat-card__value @(CurrentYearNetAmount >= 0 ? "stat-card__value--profit" : "stat-card__value--loss")">
				@(CurrentYearNetAmount >= 0 ? "+" : "")@CurrentYearNetAmount.ToString("N0")
			</div>
			<span class="stat-card__subtitle">收入 - 支出 - 手續費</span>
		</div>

		@* 目前餘額卡片 *@
		<div class="stat-card stat-card--tcb">
			<div class="stat-card__header">
				<span class="stat-card__label">目前餘額</span>
				<svg class="stat-card__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
					<path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
				</svg>
			</div>
			<div class="stat-card__value @(CurrentBalance < 0 ? "stat-card__value--loss" : "")">
				@CurrentBalance.ToString("N0")
			</div>
			<span class="stat-card__subtitle">年初 + 本年度淨額</span>
		</div>
	</section>

	@* 資料表格區 *@
	<div class="table-card">
		<header class="table-card__header">
			<div class="table-card__title">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
					<path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
				</svg>
				<h2>@SelectedYear 年帳戶明細紀錄</h2>
				<span class="table-card__count">共 @Accounts.Count 筆</span>
			</div>
			<div class="table-card__actions">
				<div class="btn-group">
					<button class="btn btn--danger @(IsInitializing ? "btn--loading" : "")"
							@onclick="OpenInitializeDialog"
							disabled="@IsInitializing">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
							<path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
						</svg>
						初始化
					</button>
					<button class="btn btn--tcb" @onclick="OpenAddDialog">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
							<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
						</svg>
						新增
					</button>
					<button class="btn btn--icon btn--outline" @onclick="LoadDataAsync" title="重新整理">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
							<path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
						</svg>
					</button>
				</div>
			</div>
		</header>

		@if (Accounts.Count == 0)
		{
			<div class="empty-state">
				<svg class="empty-state__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
					<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"/>
				</svg>
				<p class="empty-state__text">@SelectedYear 年尚無帳戶明細紀錄</p>
				<button class="btn btn--outline" @onclick="OpenAddDialog">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
					</svg>
					新增第一筆紀錄
				</button>
			</div>
		}
		else
		{
			<div class="table-wrapper">
				<table class="data-table">
					<thead>
						<tr>
							<th>匯款日期</th>
							<th>申請部門</th>
							<th>申請人</th>
							<th>申請原因</th>
							<th>支出金額</th>
							<th>收入金額</th>
							<th>手續費</th>
							<th>淨金額</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var account in GetPagedAccounts())
						{
							<tr>
								<td>
									<span class="cell-date">
										@(account.RemittanceDate?.ToString("MM/dd") ?? "-")
									</span>
								</td>
								<td>@GetDepartmentDisplay(account.Department)</td>
								<td>@account.Applicant</td>
								<td>
									<span class="cell-truncate" data-tooltip="@account.Reason">
										@account.Reason
									</span>
								</td>
								<td class="cell-amount @(account.Expense > 0 ? "cell-amount--expense" : "cell-amount--muted")">
									@(account.Expense > 0 ? account.Expense.ToString("N0") : "-")
								</td>
								<td class="cell-amount @(account.Income > 0 ? "cell-amount--income" : "cell-amount--muted")">
									@(account.Income > 0 ? account.Income.ToString("N0") : "-")
								</td>
								<td class="cell-amount @(account.Fee > 0 ? "cell-amount--fee" : "cell-amount--muted")">
									@(account.Fee > 0 ? account.Fee.ToString("N0") : "-")
								</td>
								<td>
									<span class="cell-badge @(account.NetAmount >= 0 ? "cell-badge--profit" : "cell-badge--loss")">
										@(account.NetAmount >= 0 ? "+" : "")@account.NetAmount.ToString("N0")
									</span>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>

			<div class="pagination">
				<span class="pagination__info">
					顯示 @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, Accounts.Count) 筆，共 @Accounts.Count 筆
				</span>
				<div class="pagination__controls">
					<button class="pagination__btn" @onclick="PreviousPage" disabled="@(_currentPage == 1)">上一頁</button>
					@for (int i = 1; i <= TotalPages; i++)
					{
						var pageNum = i;
						<button class="pagination__btn @(pageNum == _currentPage ? "pagination__btn--active" : "")"
								@onclick="() => GoToPage(pageNum)">
							@pageNum
						</button>
					}
					<button class="pagination__btn" @onclick="NextPage" disabled="@(_currentPage >= TotalPages)">下一頁</button>
					<select class="pagination__select" @onchange="OnPageSizeChanged" value="@_pageSize">
						<option value="10">10 筆/頁</option>
						<option value="15" selected="@(_pageSize == 15)">15 筆/頁</option>
						<option value="25">25 筆/頁</option>
						<option value="50">50 筆/頁</option>
					</select>
				</div>
			</div>
		}
	</div>
</div>

@* 新增明細 Dialog *@
@if (IsAddDialogOpen)
{
	<AddTaiwanCooperativeBankAccountDialog IsOpen="true"
										   OnCancel="CloseAddDialog"
										   OnSubmit="OnAddDialogSubmitAsync" />
}

@* 確認 Dialog *@
@if (IsConfirmDialogOpen)
{
	<div class="modal-overlay modal-overlay--active" @onclick="CloseConfirmDialog">
		<div class="modal modal--small" @onclick:stopPropagation="true">
			<header class="modal__header">
				<div class="modal__header-icon modal__header-icon--danger">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
					</svg>
				</div>
				<h2 class="modal__title">初始化資料確認</h2>
			</header>
			<div class="modal__body">
				<p style="margin-bottom: var(--bank-space-md);">此操作會清空所有現有資料，並從 Excel 檔案重新匯入。</p>
				<div class="alert alert--warning">
					<svg class="alert__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
					</svg>
					<span>此操作無法復原，請確認已備份重要資料。</span>
				</div>
			</div>
			<footer class="modal__footer">
				<button class="btn btn--outline" @onclick="CloseConfirmDialog">取消</button>
				<button class="btn btn--danger @(IsInitializing ? "btn--loading" : "")"
						@onclick="OnConfirmInitializeAsync"
						disabled="@IsInitializing">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
					</svg>
					確認初始化
				</button>
			</footer>
		</div>
	</div>
}
