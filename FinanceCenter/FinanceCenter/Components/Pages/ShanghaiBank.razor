@page "/bank/scsb"
@using FinanceCenter.Components.Dialogs

<PageTitle>上海銀行帳戶明細</PageTitle>

<div class="glass-page">
	@* 頁面標題 *@
	<header class="glass-page-header glass-page-header--with-icon">
		<div class="glass-page-header__icon glass-page-header__icon--teal">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
				<path d="M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"/>
			</svg>
		</div>
		<div>
			<h1 class="glass-page-title">上海銀行帳戶明細</h1>
			<p class="glass-page-subtitle">Shanghai Commercial & Savings Bank Account Details</p>
		</div>
	</header>

	@* 資料表格區 *@
	<div class="glass-panel">
		<header class="glass-panel__header">
			<div class="glass-panel__header-content">
				<div class="glass-panel__header-left">
					<div class="glass-panel__year-select">
						<select class="glass-select glass-select--compact" @onchange="OnYearChangedAsync">
							@for (int year = 2019; year <= 2030; year++)
							{
								<option value="@year" selected="@(year == SelectedYear)">@year 年</option>
							}
						</select>
					</div>
					<div class="glass-panel__header-info">
						<h2>帳戶明細紀錄</h2>
						<p class="glass-panel__header-meta">共 @Accounts.Count 筆</p>
					</div>
				</div>
				<div class="glass-btn-group">
					<button class="glass-btn glass-btn--danger @(IsInitializing ? "glass-btn--loading" : "")"
							@onclick="OpenInitializeDialog"
							disabled="@IsInitializing">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
							<path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
						</svg>
						初始化
					</button>
					<button class="glass-btn glass-btn--primary" @onclick="OpenAddDialog">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
							<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
						</svg>
						新增
					</button>
					<button class="glass-btn glass-btn--ghost glass-btn--icon" @onclick="LoadDataAsync" title="重新整理">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
							<path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
						</svg>
					</button>
				</div>
			</div>
		</header>

		<div class="glass-panel__content">
			@if (Accounts.Count == 0)
			{
				<div class="glass-empty-state">
					<div class="glass-empty-state__icon">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/>
							<path d="M12 10v6"/>
							<path d="m9 13 3-3 3 3"/>
						</svg>
					</div>
					<h3>@SelectedYear 年尚無帳戶明細紀錄</h3>
					<p>建立您的第一筆紀錄以開始管理</p>
					<button class="glass-btn glass-btn--primary" @onclick="OpenAddDialog">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
							<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
						</svg>
						新增第一筆紀錄
					</button>
				</div>
			}
			else
			{
				<div class="glass-table-wrapper">
					<table class="glass-table">
						<thead>
							<tr>
								<th>匯款日期</th>
								<th>申請部門</th>
								<th>申請人</th>
								<th>申請原因</th>
								<th>支出金額</th>
								<th>收入金額</th>
								<th>手續費</th>
								<th>餘額</th>
								<th class="glass-table__actions-header">操作</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var account in GetPagedAccounts())
							{
								var balance = GetBalance(account.Id);
								<tr>
									<td>
										<span class="glass-cell-date">
											@(account.RemittanceDate?.ToString("MM/dd") ?? "-")
										</span>
									</td>
									<td>@GetDepartmentDisplay(account.Department)</td>
									<td>@account.Applicant</td>
									<td>
										<span class="glass-cell-truncate" data-glass-tooltip="@account.Reason">
											@account.Reason
										</span>
									</td>
									<td class="glass-cell-amount @(account.Expense > 0 ? "glass-cell-amount--expense" : "glass-cell-amount--muted")">
										@(account.Expense > 0 ? account.Expense.ToString("N0") : "-")
									</td>
									<td class="glass-cell-amount @(account.Income > 0 ? "glass-cell-amount--income" : "glass-cell-amount--muted")">
										@(account.Income > 0 ? account.Income.ToString("N0") : "-")
									</td>
									<td class="glass-cell-amount @(account.Fee > 0 ? "glass-cell-amount--fee" : "glass-cell-amount--muted")">
										@(account.Fee > 0 ? account.Fee.ToString("N0") : "-")
									</td>
									<td>
										<span class="glass-cell-badge @(balance >= 0 ? "glass-cell-badge--profit" : "glass-cell-badge--loss")">
											@balance.ToString("N0")
										</span>
									</td>
									<td class="glass-table__actions">
										<button class="glass-action-btn glass-action-btn--edit"
												@onclick="() => OpenEditDialog(account)"
												title="異動">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
												<path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
											</svg>
										</button>
										<button class="glass-action-btn glass-action-btn--delete"
												@onclick="() => OpenDeleteDialog(account)"
												title="刪除">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
												<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
											</svg>
										</button>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>

				<div class="glass-pagination">
					<span class="glass-pagination__info">
						顯示 @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, Accounts.Count) 筆，共 @Accounts.Count 筆
					</span>
					<div class="glass-pagination__controls">
						<button class="glass-pagination__btn" @onclick="PreviousPage" disabled="@(_currentPage == 1)">上一頁</button>
						@for (int i = 1; i <= TotalPages; i++)
						{
							var pageNum = i;
							<button class="glass-pagination__btn @(pageNum == _currentPage ? "glass-pagination__btn--active" : "")"
									@onclick="() => GoToPage(pageNum)">
								@pageNum
							</button>
						}
						<button class="glass-pagination__btn" @onclick="NextPage" disabled="@(_currentPage >= TotalPages)">下一頁</button>
						<select class="glass-pagination__select" @onchange="OnPageSizeChanged" value="@_pageSize">
							<option value="10">10 筆/頁</option>
							<option value="15" selected="@(_pageSize == 15)">15 筆/頁</option>
							<option value="25">25 筆/頁</option>
							<option value="50">50 筆/頁</option>
						</select>
					</div>
				</div>
			}
		</div>
	</div>
</div>

@* 新增明細 Dialog *@
@if (IsAddDialogOpen)
{
	<AddShanghaiBankAccountDialog IsOpen="true"
								  OnCancel="CloseAddDialog"
								  OnSubmit="OnAddDialogSubmitAsync" />
}

@* 編輯明細 Dialog *@
@if (IsEditDialogOpen && EditingAccount != null)
{
	<EditShanghaiBankAccountDialog IsOpen="true"
								   Account="EditingAccount"
								   OnCancel="CloseEditDialog"
								   OnSubmit="OnEditDialogSubmitAsync" />
}

@* 初始化確認 Dialog *@
@if (IsConfirmDialogOpen)
{
	<div class="glass-modal-overlay glass-modal-overlay--active" @onclick="CloseConfirmDialog">
		<div class="glass-modal glass-modal--small" @onclick:stopPropagation="true">
			<header class="glass-modal__header">
				<div class="glass-modal__header-icon glass-modal__header-icon--danger">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
					</svg>
				</div>
				<h2 class="glass-modal__title">初始化資料確認</h2>
			</header>
			<div class="glass-modal__body">
				<p style="margin-bottom: var(--glass-space-md);">此操作會清空所有現有資料，並從 Excel 檔案重新匯入。</p>
				<div class="glass-alert glass-alert--warning">
					<svg class="glass-alert__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
					</svg>
					<span>此操作無法復原，請確認已備份重要資料。</span>
				</div>
			</div>
			<footer class="glass-modal__footer">
				<button class="glass-btn glass-btn--outline" @onclick="CloseConfirmDialog">取消</button>
				<button class="glass-btn glass-btn--danger @(IsInitializing ? "glass-btn--loading" : "")"
						@onclick="OnConfirmInitializeAsync"
						disabled="@IsInitializing">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
					</svg>
					確認初始化
				</button>
			</footer>
		</div>
	</div>
}

@* 刪除確認 Dialog *@
@if (IsDeleteDialogOpen && DeletingAccount != null)
{
	<div class="glass-modal-overlay glass-modal-overlay--active" @onclick="CloseDeleteDialog">
		<div class="glass-modal glass-modal--small" @onclick:stopPropagation="true">
			<header class="glass-modal__header">
				<div class="glass-modal__header-icon glass-modal__header-icon--danger">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
					</svg>
				</div>
				<h2 class="glass-modal__title">刪除確認</h2>
			</header>
			<div class="glass-modal__body">
				<p style="margin-bottom: var(--glass-space-md);">確定要刪除這筆紀錄嗎？</p>
				<div class="glass-delete-preview">
					<div class="glass-delete-preview__item">
						<span class="glass-delete-preview__label">日期</span>
						<span class="glass-delete-preview__value">@(DeletingAccount.RemittanceDate?.ToString("yyyy/MM/dd") ?? "-")</span>
					</div>
					<div class="glass-delete-preview__item">
						<span class="glass-delete-preview__label">申請人</span>
						<span class="glass-delete-preview__value">@DeletingAccount.Applicant</span>
					</div>
					<div class="glass-delete-preview__item">
						<span class="glass-delete-preview__label">原因</span>
						<span class="glass-delete-preview__value">@DeletingAccount.Reason</span>
					</div>
					<div class="glass-delete-preview__item">
						<span class="glass-delete-preview__label">金額</span>
						<span class="glass-delete-preview__value">
							@if (DeletingAccount.Income > 0)
							{
								<span class="glass-cell-amount--income">+@DeletingAccount.Income.ToString("N0")</span>
							}
							@if (DeletingAccount.Expense > 0)
							{
								<span class="glass-cell-amount--expense">-@DeletingAccount.Expense.ToString("N0")</span>
							}
						</span>
					</div>
				</div>
				<div class="glass-alert glass-alert--warning">
					<svg class="glass-alert__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
					</svg>
					<span>此操作無法復原。</span>
				</div>
			</div>
			<footer class="glass-modal__footer">
				<button class="glass-btn glass-btn--outline" @onclick="CloseDeleteDialog">取消</button>
				<button class="glass-btn glass-btn--danger @(IsDeleting ? "glass-btn--loading" : "")"
						@onclick="OnConfirmDeleteAsync"
						disabled="@IsDeleting">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
						<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
					</svg>
					確認刪除
				</button>
			</footer>
		</div>
	</div>
}
