@page "/bank/scsb"

<PageTitle>上海銀行帳戶明細</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
	@* 頁面標題區 *@
	<MudStack Row AlignItems="AlignItems.Center" Class="mb-6">
		<MudAvatar Color="Color.Secondary" Size="Size.Large" Variant="Variant.Filled">
			<MudIcon Icon="@Icons.Material.Filled.AccountBalance" />
		</MudAvatar>
		<MudStack Spacing="0">
			<MudText Typo="Typo.h5" Class="font-semibold">上海銀行帳戶明細</MudText>
			<MudText Typo="Typo.body2" Color="Color.Secondary">Shanghai Commercial & Savings Bank Account Details</MudText>
		</MudStack>
		<MudSpacer />
		<MudChipSet T="string">
			<MudChip T="string" Color="Color.Secondary" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.CalendarMonth">
				@SelectedYear 年度
			</MudChip>
		</MudChipSet>
	</MudStack>

	@* 統計卡片區 *@
	<MudGrid Spacing="4" Class="mb-6">
		@* 年份選擇卡片 *@
		<MudItem xs="12" sm="6" md="3">
			<MudPaper Class="pa-4 rounded-lg" Style="border-left: 4px solid var(--mud-palette-info);" Elevation="2">
				<MudStack Spacing="2">
					<MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
						<MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase font-semibold">選擇年份</MudText>
						<MudIcon Icon="@Icons.Material.Filled.DateRange" Color="Color.Info" Size="Size.Small" />
					</MudStack>
					<MudSelect T="int" Value="@SelectedYear" ValueChanged="OnYearChangedAsync"
							   Variant="Variant.Filled" Dense="true" Margin="Margin.Dense"
							   Class="mt-1" Style="background-color: var(--mud-palette-background-grey);">
						@foreach (var year in AvailableYears)
						{
							<MudSelectItem Value="@year">@year 年</MudSelectItem>
						}
					</MudSelect>
				</MudStack>
			</MudPaper>
		</MudItem>

		@* 年初餘額卡片 *@
		<MudItem xs="12" sm="6" md="3">
			<MudPaper Class="pa-4 rounded-lg" Style="border-left: 4px solid var(--mud-palette-tertiary);" Elevation="2">
				<MudStack Spacing="2">
					<MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
						<MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase font-semibold">年初餘額</MudText>
						<MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Tertiary" Size="Size.Small" />
					</MudStack>
					<MudText Typo="Typo.h5" Class="font-bold" Color="@(OpeningBalance >= 0 ? Color.Dark : Color.Error)">
						@OpeningBalance.ToString("N0")
					</MudText>
					<MudText Typo="Typo.caption" Color="Color.Secondary">上年度結餘</MudText>
				</MudStack>
			</MudPaper>
		</MudItem>

		@* 本年度淨額卡片 *@
		<MudItem xs="12" sm="6" md="3">
			<MudPaper Class="pa-4 rounded-lg" Style="@GetNetAmountCardStyle()" Elevation="2">
				<MudStack Spacing="2">
					<MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
						<MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase font-semibold">本年度淨額</MudText>
						<MudIcon Icon="@(CurrentYearNetAmount >= 0 ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingDown)"
								 Color="@(CurrentYearNetAmount >= 0 ? Color.Success : Color.Error)" Size="Size.Small" />
					</MudStack>
					<MudText Typo="Typo.h5" Class="font-bold" Color="@(CurrentYearNetAmount >= 0 ? Color.Success : Color.Error)">
						@(CurrentYearNetAmount >= 0 ? "+" : "")@CurrentYearNetAmount.ToString("N0")
					</MudText>
					<MudText Typo="Typo.caption" Color="Color.Secondary">收入 - 支出 - 手續費</MudText>
				</MudStack>
			</MudPaper>
		</MudItem>

		@* 目前餘額卡片 *@
		<MudItem xs="12" sm="6" md="3">
			<MudPaper Class="pa-4 rounded-lg" Style="border-left: 4px solid var(--mud-palette-secondary);" Elevation="2">
				<MudStack Spacing="2">
					<MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
						<MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase font-semibold">目前餘額</MudText>
						<MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Secondary" Size="Size.Small" />
					</MudStack>
					<MudText Typo="Typo.h5" Class="font-bold" Color="@(CurrentBalance >= 0 ? Color.Secondary : Color.Error)">
						@CurrentBalance.ToString("N0")
					</MudText>
					<MudText Typo="Typo.caption" Color="Color.Secondary">年初 + 本年度淨額</MudText>
				</MudStack>
			</MudPaper>
		</MudItem>
	</MudGrid>

	@* 資料表格區 *@
	<MudPaper Class="rounded-lg" Elevation="2">
		<MudDataGrid T="ShanghaiBankAccount" Items="@Accounts" Filterable="true" SortMode="SortMode.Multiple"
					 Hover="true" Dense="true" Class="rounded-lg" RowsPerPage="15">
			<ToolBarContent>
				<MudStack Row AlignItems="AlignItems.Center" Class="flex-grow-1">
					<MudIcon Icon="@Icons.Material.Filled.ListAlt" Color="Color.Secondary" />
					<MudText Typo="Typo.h6">@SelectedYear 年帳戶明細紀錄</MudText>
					<MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
						共 @Accounts.Count 筆
					</MudChip>
				</MudStack>
				<MudSpacer />
				<MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
					<MudButton Color="Color.Error" StartIcon="@Icons.Material.Filled.RestartAlt" OnClick="OpenInitializeDialogAsync">
						初始化
					</MudButton>
					<MudButton Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialogAsync">
						新增
					</MudButton>
					<MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="RefreshDataAsync" Color="Color.Default" />
				</MudButtonGroup>
			</ToolBarContent>
			<Columns>
				<PropertyColumn Property="x => x.RemittanceDate" Title="匯款日期" Format="MM-dd" Sortable="true">
					<CellTemplate>
						<MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Default">
							@(context.Item.RemittanceDate?.ToString("MM/dd") ?? "-")
						</MudChip>
					</CellTemplate>
				</PropertyColumn>
				<TemplateColumn Title="申請部門" Sortable="true">
					<CellTemplate>
						<MudText Typo="Typo.body2">@GetDepartmentDisplay(context.Item.Department)</MudText>
					</CellTemplate>
				</TemplateColumn>
				<PropertyColumn Property="x => x.Applicant" Title="申請人" Sortable="true" />
				<PropertyColumn Property="x => x.Reason" Title="申請原因">
					<CellTemplate>
						<MudTooltip Text="@context.Item.Reason" Placement="Placement.Top">
							<MudText Typo="Typo.body2" Class="text-truncate" Style="max-width: 200px;">
								@context.Item.Reason
							</MudText>
						</MudTooltip>
					</CellTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.Expense" Title="支出金額" Format="N0" Sortable="true">
					<CellTemplate>
						<MudText Typo="Typo.body2" Color="@(context.Item.Expense > 0 ? Color.Error : Color.Default)" Class="text-right">
							@(context.Item.Expense > 0 ? context.Item.Expense.ToString("N0") : "-")
						</MudText>
					</CellTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.Income" Title="收入金額" Format="N0" Sortable="true">
					<CellTemplate>
						<MudText Typo="Typo.body2" Color="@(context.Item.Income > 0 ? Color.Success : Color.Default)" Class="text-right">
							@(context.Item.Income > 0 ? context.Item.Income.ToString("N0") : "-")
						</MudText>
					</CellTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.Fee" Title="手續費" Format="N0" Sortable="true">
					<CellTemplate>
						<MudText Typo="Typo.body2" Color="Color.Warning" Class="text-right">
							@(context.Item.Fee > 0 ? context.Item.Fee.ToString("N0") : "-")
						</MudText>
					</CellTemplate>
				</PropertyColumn>
				<PropertyColumn Property="x => x.NetAmount" Title="淨金額" Format="N0" Sortable="false" Filterable="false">
					<CellTemplate>
						<MudChip T="string" Size="Size.Small" Color="@(context.Item.NetAmount >= 0 ? Color.Success : Color.Error)"
								 Variant="Variant.Filled" Class="font-semibold">
							@(context.Item.NetAmount >= 0 ? "+" : "")@context.Item.NetAmount.ToString("N0")
						</MudChip>
					</CellTemplate>
				</PropertyColumn>
			</Columns>
			<PagerContent>
				<MudDataGridPager T="ShanghaiBankAccount" PageSizeOptions="new int[] { 10, 15, 25, 50 }" />
			</PagerContent>
			<NoRecordsContent>
				<MudStack AlignItems="AlignItems.Center" Class="py-8">
					<MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
					<MudText Typo="Typo.body1" Color="Color.Secondary">@SelectedYear 年尚無帳戶明細紀錄</MudText>
					<MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add"
							   OnClick="OpenAddDialogAsync" Class="mt-2">
						新增第一筆紀錄
					</MudButton>
				</MudStack>
			</NoRecordsContent>
		</MudDataGrid>
	</MudPaper>
</MudContainer>

@code {
	private string GetNetAmountCardStyle()
	{
		var color = CurrentYearNetAmount >= 0 ? "var(--mud-palette-success)" : "var(--mud-palette-error)";
		return $"border-left: 4px solid {color};";
	}
}
